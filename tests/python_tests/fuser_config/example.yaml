dest_acc: true
loop_factor: 16

operations:
  - src_a: "input_A"
    src_b: "input_B"
    output: "datacopy_output"
    src_a_dims: [96, 128]
    src_b_dims: [96, 128]
    output_dims: [96, 128]
    input_format: "Float16_b"
    output_format: "Float16_b"
    math:
      - type: "Fpu"
        operation: "Datacopy"
        unpacker: "UnpackerA"
        broadcast_type: "SCALAR"
      - type: "UnarySfpu"
        operation: "Fill"
        approximation_mode: false
        iterations: 32
        dst_dest_tile_index: 0
        fill_const_value: 1.0
      - type: "Fpu"
        operation: "Elwadd"
        unpacker: "UnpackerAB"
    packer: "Packer"
    math_fidelity: "LoFi"
    block_size: [64, 64]

  - src_a: "datacopy_output"
    src_b: "input_B"
    output: "tilized_output"
    src_a_dims: [96, 128]
    src_b_dims: [96, 128]
    output_dims: [96, 128]
    input_format: "Float16_b"
    output_format: "Float16_b"
    math:
      - type: "Fpu"
        operation: "Datacopy"
        unpacker: "UnpackerTilizeA"
      - type: "UnarySfpu"
        operation: "Exp"
        approximation_mode: false
        iterations: 64
      - type: "UnarySfpu"
        operation: "Celu"
        approximation_mode: false
        iterations: 64
      - type: "BinarySfpu"
        operation: "SfpuElwadd"
        approximation_mode: false
        iterations: 32
        src1_dest_tile_index: 0
        src2_dest_tile_index: 1
        dst_dest_tile_index: 1
    packer: "Packer"
    math_fidelity: "LoFi"
    block_size: [64, 64]

  # - src_a: "tilized_output"
  #   src_b: "X"
  #   output: "reduced_output"
  #   src_a_dims: [96, 128]
  #   src_b_dims: [96, 128]
  #   output_dims: [96, 128]
  #   src_b_const_value: 1.0 # 0.03125 for Reduce Average
  #   input_format: "Float16_b"
  #   output_format: "Float16_b"
  #   math:
  #     - type: "Fpu"
  #       operation: "ReduceRow"
  #       reduce_pool: "MAX"
  #       unpacker: "UnpackerAB"
  #     - type: "Fpu"
  #       operation: "ReduceRow"
  #       reduce_pool: "SUM"
  #       unpacker: "UnpackerAB"
  #     # - type: "Fpu"
  #     #   operation: "ReduceRow"
  #     #   reduce_pool: "AVG"
  #     #   unpacker: "UnpackerAB"
  #     - type: "BinarySfpu"
  #       operation: "SfpuElwadd"
  #       approximation_mode: false
  #       iterations: 8
  #       src1_dest_tile_index: 0
  #       src2_dest_tile_index: 0
  #       dst_dest_tile_index: 0
  #   packer: "Packer"
  #   math_fidelity: "HiFi4"

  - src_a: "reduced_output"
    src_b: "input_B"
    output: "elwadd1"
    src_a_dims: [96, 128]
    src_b_dims: [96, 128]
    output_dims: [96, 128]
    input_format: "Float16_b"
    output_format: "Float16_b"
    math:
      - type: "Fpu"
        operation: "Elwadd"
        unpacker: "UnpackerAB"
        unpack_transpose_within_face: true
        unpack_transpose_faces: true
      - type: "UnarySfpu"
        operation: "Neg"
        approximation_mode: false
        iterations: 32
    packer: "Packer"
    math_fidelity: "LoFi"
    dest_sync: "SyncFull"

  - src_a: "elwadd1"
    src_b: "input_C"
    output: "matmul_result"
    src_a_dims: [96, 128]
    src_b_dims: [128, 128]
    output_dims: [32, 128]
    input_format: "Float16_b"
    output_format: "Float32"
    math:
      - type: "Fpu"
        operation: "Matmul"
        unpacker: "MatmulUnpacker"
      - type: "UnarySfpu"
        operation: "Abs"
        approximation_mode: false
        iterations: 32
      - type: "UnarySfpu"
        operation: "Sqrt"
        approximation_mode: false
        iterations: 32
    packer: "Packer"
    math_fidelity: "HiFi2"

  - src_a: "matmul_result"
    src_b: "input_D"
    output: "final_output"
    src_a_dims: [32, 128]
    src_b_dims: [128, 32]
    output_dims: [32, 32]
    input_format: "Float32"
    output_format: "Float32"
    math:
      - type: "Fpu"
        operation: "Matmul"
        unpacker: "MatmulUnpacker"
      - type: "UnarySfpu"
        operation: "Sqrt"
        approximation_mode: false
        iterations: 32
      - type: "BinarySfpu"
        operation: "SfpuElwadd"
        approximation_mode: false
        iterations: 32
        src1_dest_tile_index: 0
        src2_dest_tile_index: 0
        dst_dest_tile_index: 0
    packer: "Packer"
    math_fidelity: "LoFi"
