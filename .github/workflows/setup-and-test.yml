name: "⚙️ Setup and Test"

on:
  workflow_call:
    inputs:
      docker_image:
        description: "The Docker image to use for the container"
        required: true
        type: string
      runs_on:
        description: "The runner to use for the job"
        required: true
        type: string
      matrix_size:
        description: "The size of the test group matrix"
        required: true
        type: number

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          MATRIX_JSON=$(seq 1 ${{ inputs.matrix_size }} | jq -R . | jq -s '[.[] | {test_group: .}]')
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  setup-and-test:
    runs-on: ${{ inputs.runs_on }}
    timeout-minutes: 80
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        test_group: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    container:
      image: ${{ inputs.docker_image }}
      options: "--rm --device /dev/tenstorrent"
    name: "🦄 Run tests (group ${{ matrix.test_group }}/${{ inputs.matrix_size }})"
    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Install SFPI
      - name: Install SFPI
        shell: bash
        run: |
          cd tests
          ./setup_testing_env.sh
          cd ..

      # Step 3: Run the tests
      - name: Run tests
        shell: bash
        run: |
          cd tests/python_tests/
          pytest --splits ${{ inputs.matrix_size }} --group ${{ matrix.test_group }} \
          --override-ini="addopts=-v" --timeout=60 .

      # Step 4: Upload test log as an artifact
      - name: Upload logs if tests fail
        if: failure()  # Only upload the log if the previous step failed
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: tests/python_tests/pytest_errors_${{ matrix.test_group }}.log
