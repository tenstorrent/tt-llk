name: 🚀 Trigger tt-metal integration tests

# This workflow triggers comprehensive integration tests in the tt-metal repository
# when labels are added to PRs. It handles fork branch mirroring, analyzes file changes
# to determine which tests to run, and uses workflow_call to trigger the tt-metal workflow.

on:
  pull_request:
    types: [labeled, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test with'
        required: true
        type: number

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  actions: write
  issues: write

jobs:
  setup-branch:
    name: "🔧 Setup branch for testing"
    runs-on: ubuntu-latest
    outputs:
      branch-to-run: ${{
        steps.check-fork.outputs.is-fork == 'true' &&
        steps.mirror-branch.outputs.branch-to-run ||
        steps.set-internal-branch.outputs.branch-to-run }}
      is-fork: ${{ steps.check-fork.outputs.is-fork }}
    steps:
      - name: Get PR information
        id: get-pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual dispatch - get PR info from API
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
            HEAD_REPO=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
            HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
            echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "head-repo=$HEAD_REPO" >> $GITHUB_OUTPUT
            echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          else
            # PR event - use event data
            echo "pr-number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "head-repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "head-ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Check if this is a fork PR
        id: check-fork
        run: |
          if [ "${{ steps.get-pr-info.outputs.head-repo }}" != "${{ github.repository }}" ]; then
            echo "is-fork=true" >> $GITHUB_OUTPUT
            echo "🍴 This is a fork PR from: ${{ steps.get-pr-info.outputs.head-repo }}"
          else
            echo "is-fork=false" >> $GITHUB_OUTPUT
            echo "🏠 This is an internal PR"
          fi

      - name: Mirror fork branch if needed
        id: mirror-branch
        if: steps.check-fork.outputs.is-fork == 'true'
        run: |
          FORK_OWNER=$(echo "${{ steps.get-pr-info.outputs.head-repo }}" | cut -d'/' -f1)
          SOURCE_BRANCH="${{ steps.get-pr-info.outputs.head-ref }}"
          MIRRORED_BRANCH="mirror/$FORK_OWNER/$SOURCE_BRANCH"

          echo "🪞 Triggering mirror workflow for fork branch"
          echo "  - Source: $FORK_OWNER:$SOURCE_BRANCH"
          echo "  - Target: $MIRRORED_BRANCH"

          # Trigger the mirror workflow
          gh workflow run "mirror-fork-branches.yml" \
            --repo "${{ github.repository }}" \
            --field source="$FORK_OWNER:$SOURCE_BRANCH" \
            --field target_branch="$MIRRORED_BRANCH"

          echo "branch-to-run=$MIRRORED_BRANCH" >> $GITHUB_OUTPUT
          echo "✅ Mirror workflow triggered"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set branch name for internal PRs
        id: set-internal-branch
        if: steps.check-fork.outputs.is-fork == 'false'
        run: |
          BRANCH_NAME="${{ steps.get-pr-info.outputs.head-ref }}"
          echo "branch-to-run=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "📝 Using internal branch: $BRANCH_NAME"

  wait-for-mirror:
    name: "⏳ Wait for mirror completion"
    needs: setup-branch
    if: |
      (contains(github.event.pull_request.labels.*.name, 'tt-metal-integration-tests') ||
       github.event_name == 'workflow_dispatch') &&
      needs.setup-branch.outputs.is-fork == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for mirror workflow completion
        run: |
          echo "⏳ Waiting for mirror workflow to complete..."
          sleep 60  # Give time for the mirror workflow to start

          MAX_WAIT=600  # 10 minutes
          WAIT_INTERVAL=30
          elapsed=0

          while [ $elapsed -lt $MAX_WAIT ]; do
            # Check if mirror workflow is running
            RUNNING_WORKFLOWS=$(gh run list --workflow "mirror-fork-branches.yml" \
              --repo "${{ github.repository }}" \
              --status "in_progress" \
              --limit 5 \
              --json status)

            if [ "$(echo "$RUNNING_WORKFLOWS" | jq length)" -eq 0 ]; then
              echo "✅ Mirror workflow appears to be complete"
              break
            fi

            echo "⏳ Mirror workflow still running... (elapsed: ${elapsed}s)"
            sleep $WAIT_INTERVAL
            elapsed=$((elapsed + WAIT_INTERVAL))
          done

          if [ $elapsed -ge $MAX_WAIT ]; then
            echo "⚠️ Timeout waiting for mirror workflow, proceeding anyway"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  detect-changes:
    name: "📁 Detect file changes and determine tests"
    needs: [setup-branch, wait-for-mirror]
    if: |
      always() &&
      (contains(github.event.pull_request.labels.*.name, 'tt-metal-integration-tests') ||
       github.event_name == 'workflow_dispatch') &&
      (needs.setup-branch.outputs.is-fork == 'false' || needs.wait-for-mirror.result != 'failure')
    runs-on: ubuntu-latest
    outputs:
      run-blackhole: ${{ steps.determine-tests.outputs.run-blackhole }}
      run-wormhole: ${{ steps.determine-tests.outputs.run-wormhole }}
    steps:
      - name: Checkout the appropriate branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch-to-run }}
          fetch-depth: 0

      - name: Determine which tests to run
        id: determine-tests
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the base branch - always use main for simplicity
          BASE_REF="main"
          echo "Base branch: $BASE_REF"

          # Get the list of changed files by comparing the current branch with main
          git fetch origin "$BASE_REF"
          CHANGED_FILES=$(git diff --name-only origin/"$BASE_REF"...HEAD)

          echo "📁 Changed files:"
          echo "$CHANGED_FILES"

          # Check if any files in tt_llk_blackhole directory are changed
          BLACKHOLE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "^tt_llk_blackhole/" || false)

          # Check if any files in tt_llk_wormhole_b0 directory are changed
          WORMHOLE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "^tt_llk_wormhole_b0/" || false)

          # Determine which tests to run
          RUN_BLACKHOLE="false"
          RUN_WORMHOLE="false"

          if [ -n "$BLACKHOLE_CHANGES" ]; then
            echo "🕳️ Blackhole files changed:"
            echo "$BLACKHOLE_CHANGES"
            RUN_BLACKHOLE="true"
          fi

          if [ -n "$WORMHOLE_CHANGES" ]; then
            echo "🌀 Wormhole files changed:"
            echo "$WORMHOLE_CHANGES"
            RUN_WORMHOLE="true"
          fi

          echo "run-blackhole=$RUN_BLACKHOLE" >> $GITHUB_OUTPUT
          echo "run-wormhole=$RUN_WORMHOLE" >> $GITHUB_OUTPUT

          echo "📊 Test Configuration:"
          echo "  - Blackhole tests: $RUN_BLACKHOLE"
          echo "  - Wormhole tests: $RUN_WORMHOLE"

  trigger-tt-metal-tests:
    name: "🚀 Trigger tt-metal integration tests"
    needs: [setup-branch, wait-for-mirror, detect-changes]
    if: |
      always() &&
      (contains(github.event.pull_request.labels.*.name, 'tt-metal-integration-tests') ||
       github.event_name == 'workflow_dispatch') &&
      needs.detect-changes.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      tt-metal-run-id: ${{ steps.get-run-id.outputs.run-id }}
      tt-metal-run-url: ${{ steps.get-run-id.outputs.run-url }}
    steps:
      - name: Trigger tt-metal workflow
        id: trigger-workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Trigger the tt-metal workflow
          WORKFLOW_NAME="test-llk-metal-integration.yaml"  # or whatever the filename is

          gh workflow run "$WORKFLOW_NAME" \
            --repo tenstorrent/tt-metal \
            --ref fvranicTT/add-llk-metal-integration-testing-workflow \
            --field mirrored_branch="${{ needs.setup-branch.outputs.branch-to-run }}" \
            --field run_all_post_commit="${{ needs.detect-changes.outputs.run-wormhole == 'true' }}" \
            --field run_blackhole_post_commit="${{ needs.detect-changes.outputs.run-blackhole == 'true' }}" \
            --field workflow_timeout="240"

          echo "✅ tt-metal workflow triggered successfully"

      - name: Get workflow run ID
        id: get-run-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a moment for the workflow to appear
          sleep 10

          # Get the most recent workflow run for the tt-metal integration workflow
          WORKFLOW_NAME="test-llk-metal-integration.yml"  # Must match above
          RUN_DATA=$(gh run list \
            --workflow "$WORKFLOW_NAME" \
            --repo tenstorrent/tt-metal \
            --limit 1 \
            --json databaseId,url,createdAt)

          RUN_ID=$(echo "$RUN_DATA" | jq -r '.[0].databaseId // empty')
          RUN_URL=$(echo "$RUN_DATA" | jq -r '.[0].url // empty')

          if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
            echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
            echo "run-url=$RUN_URL" >> $GITHUB_OUTPUT
            echo "🎯 Found tt-metal run ID: $RUN_ID"
            echo "🔗 Run URL: $RUN_URL"
          else
            echo "⚠️ Could not find tt-metal run ID"
            echo "run-id=" >> $GITHUB_OUTPUT
            echo "run-url=" >> $GITHUB_OUTPUT
          fi

  post-comment:
    name: "💬 Post workflow status comment"
    needs: [setup-branch, detect-changes, trigger-tt-metal-tests]
    if: |
      always() &&
      (contains(github.event.pull_request.labels.*.name, 'tt-metal-integration-tests') ||
       github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.get-pr-number.outputs.pr-number }}
    steps:
      - name: Get PR number
        id: get-pr-number
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr-number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr-number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Post comment on PR
        uses: mshick/add-pr-comment@v2
        with:
          issue: ${{ steps.get-pr-number.outputs.pr-number }}
          message: |
            ## 🚀 tt-metal Integration Tests Triggered

            **Branch:** `${{ needs.setup-branch.outputs.branch-to-run }}`
            **Test Configuration:**
            - Wormhole tests: ${{
                  needs.detect-changes.outputs.run-wormhole == 'true' &&
                  '✅ Enabled' || '❌ Disabled' }}
            - Blackhole tests: ${{
                  needs.detect-changes.outputs.run-blackhole == 'true' &&
                  '✅ Enabled' || '❌ Disabled' }}

            **Status:** ${{
              needs.trigger-tt-metal-tests.result == 'success' &&
              '✅ Successfully triggered' || '❌ Failed to trigger' }}

            ## 🔗 Links
            ${{
              needs.trigger-tt-metal-tests.outputs.tt-metal-run-url != '' &&
              format('🎯 **tt-metal Integration Tests:** [Run #{0}]({1})',
                     needs.trigger-tt-metal-tests.outputs.tt-metal-run-id,
                     needs.trigger-tt-metal-tests.outputs.tt-metal-run-url) ||
              '🔗 **Monitor progress:** [tt-metal Actions](https://github.com/tenstorrent/tt-metal/actions)'
            }}
            📊 **This workflow:** [Run #${{ github.run_id }}](${{
              github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ${{
              needs.trigger-tt-metal-tests.result != 'success' &&
              '⚠️ The workflow trigger failed. Please check the logs above.' || ''
            }}
