name: üåô Nightly Tests

on:
  schedule:
    # Run every night at 1AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      pytest_markers:
        description: "Pytest mark expression for testing (e.g., 'nightly', 'perf')"
        required: false
        default: "not perf"
        type: string

permissions:
  checks: write
  contents: read
  packages: write

jobs:
  build-images:
    name: "üê≥Ô∏è Docker setup"
    uses: ./.github/workflows/build-images.yml

  nightly-test-wormhole:
    name: "üåÄ Nightly Tests (Wormhole)"
    uses: ./.github/workflows/setup-and-test.yml
    secrets: inherit
    needs: build-images
    with:
      docker_image: ${{ needs.build-images.outputs.docker-image }}
      runs_on: tt-ubuntu-2204-n150-stable
      test_splits: 10
      pytest_markers: ${{ inputs.pytest_markers || 'not perf and not quasar' }}
      random_order: false
      timeout_minutes: 360
      coverage: true

  nightly-test-blackhole:
    name: "üï≥Ô∏è Nightly Tests (Blackhole)"
    uses: ./.github/workflows/setup-and-test.yml
    secrets: inherit
    needs: build-images
    with:
      docker_image: ${{ needs.build-images.outputs.docker-image }}
      runs_on: tt-ubuntu-2204-p150b-stable
      test_splits: 10
      pytest_markers: ${{ inputs.pytest_markers || 'not perf and not quasar' }}
      random_order: false
      timeout_minutes: 360
      coverage: true

  nightly-summary:
    name: "üìä Nightly Summary"
    if: always()
    needs:
      - nightly-test-wormhole
      - nightly-test-blackhole
    runs-on: ubuntu-latest
    steps:
      - name: Check nightly test results
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  report-failure:
    name: "üîî Report failure"
    runs-on: ubuntu-latest
    if: ${{ failure() }}
    needs: nightly-summary
    steps:
      - name: Construct message
        id: message
        run: |
          COMMIT_URL="https://github.com/tenstorrent/tt-metal/commit/${{ github.sha }}"
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          RUN_BASE="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RUN_URL="$RUN_BASE/job/${{ job.check_run_id }}"
          TRIGGERER="${{ github.event.sender.login }}"
          if [ -z "$TRIGGERER" ]; then
            TRIGGERER="scheduled run"
          fi
          MESSAGE=":alert: *Nightly Tests* have failed :alert:"
          MESSAGE="$MESSAGE\n\n‚ö†Ô∏è Looks like something broke! The nightly tests didn't complete successfully."
          MESSAGE="$MESSAGE\n\nTriggered by: \`$TRIGGERER\`"
          MESSAGE="$MESSAGE\nCommit: <$COMMIT_URL|$COMMIT_SHA>"
          MESSAGE="$MESSAGE\n<${RUN_URL}|Check what went wrong>"
          echo "text=$MESSAGE" >> $GITHUB_OUTPUT
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL_ID }}",
              "text": "${{ steps.message.outputs.text }}"
            }
