name: ðŸŒ™ Nightly Performance Tests

on:
  schedule:
    # Run every night at 3AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  actions: write
  checks: write
  contents: read
  packages: write
  pull-requests: write

jobs:
  nightly-performance-tests:
    name: "ðŸš€ Nightly Performance Tests"
    uses: ./.github/workflows/run-perf-tests.yml
    secrets: inherit

  rerun-failed-jobs:
    name: "ðŸ”„ Rerun failed jobs"
    needs: nightly-performance-tests
    if: ${{ failure() && fromJSON(github.run_attempt) < 3 }}
    runs-on: ubuntu-latest
    steps:
      - name: Rerun only failed jobs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ”„ Retrying failed jobs (attempt ${{ github.run_attempt }})..."
          gh run rerun ${{ github.run_id }} --failed --repo ${{ github.repository }}

  report-status:
    name: "ðŸ”” Report status"
    runs-on: ubuntu-latest
    if: >-
      always() &&
      (fromJSON(github.run_attempt) > 2 || needs.nightly-performance-tests.result == 'success')
    needs: [nightly-performance-tests, rerun-failed-jobs]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Report status
        uses: ./.github/actions/report-failure
        with:
          test_name: "Nightly Performance Tests"
          slack_bot_token: ${{ secrets.SLACK_BOT_TOKEN }}
          slack_channel_id: ${{ secrets.SLACK_CHANNEL_ID }}
          status: ${{ needs.nightly-performance-tests.result }}
