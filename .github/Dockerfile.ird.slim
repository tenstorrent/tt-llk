ARG FROM_TAG=latest
FROM ghcr.io/tenstorrent/tt-llk/tt-llk-base-ubuntu-22-04:${FROM_TAG} AS llk-ird-build
SHELL ["/bin/bash", "-c"]

# Copy only necessary files
COPY tests/requirements.txt /tmp/requirements_tests.txt
COPY .github/scripts/install-tests-dependencies.sh \
     .github/scripts/install-exalens.sh \
     .github/scripts/install-smi.sh \
     /tmp/scripts/

RUN apt-get update && apt-get install -y --no-install-recommends \
    ssh \
    sudo && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install all dependencies in a single layer and clean up
RUN set -e \
    # Make scripts executable
    && chmod +x /tmp/scripts/*.sh \
    # Install pytest dependencies
    && /tmp/scripts/install-tests-dependencies.sh \
    # Install tt-exalens
    && /tmp/scripts/install-exalens.sh \
    # Install tt-smi
    && /tmp/scripts/install-smi.sh \
    # Clean up temporary files and caches
    && rm -rf /tmp/* \
    && rm -rf /root/.cache/pip \
    && rm -rf /root/.cache/* \
    && rm -rf /usr/share/doc/* \
    && rm -rf /usr/share/man/* \
    && find /usr/local -name "*.pyc" -delete \
    && find /usr/local -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
